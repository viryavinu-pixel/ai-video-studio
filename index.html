<script>
let story = "";
let scenes = [];
let dialogues = [];
let images = [];

// REAL GPT-STYLE STORY ENGINE (OFFLINE SAFE)
function generateStory() {
  let idea = document.getElementById("idea").value.trim();
  let genre = document.getElementById("genre").value;
  let tone = document.getElementById("tone").value;

  if (!idea) return alert("Enter a story idea!");

  function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

  let hooks = [
    "It started with one unexpected decision.",
    "Nobody imagined what would follow.",
    "One night changed everything forever.",
    "Fate intervened without warning."
  ];

  let rising = [
    "The main character begins to struggle emotionally.",
    "A hidden truth slowly comes to light.",
    "An impossible choice forces action.",
    "Pressure builds as time runs out."
  ];

  let climax = [
    "A powerful confrontation reshapes destiny.",
    "A sacrifice changes the outcome.",
    "Fear is overcome by courage.",
    "The truth finally explodes into the open."
  ];

  let ending = [
    "The character emerges transformed.",
    "Hope survives despite the pain.",
    "A bittersweet ending closes the chapter.",
    "Life continues with new meaning."
  ];

  story = `
${pick(hooks)}
${idea}.
This ${tone.toLowerCase()} ${genre.toLowerCase()} story follows a flawed hero.
${pick(rising)}
${pick(climax)}
${pick(ending)}
`.trim();

  document.getElementById("storyOutput").textContent = "ðŸ“– STORY:\n\n" + story;
}

// SCENE + DIALOGUE AI
function generateScenes() {
  if (!story) return alert("Generate story first");

  let parts = story.split(".").filter(x => x.trim());

  scenes = parts.map((text, i) => ({
    id: i + 1,
    duration: 3,
    visual: `cinematic ${document.getElementById("tone").value} movie scene, dramatic lighting, film still`,
    text: text.trim()
  }));

  dialogues = parts.map((text, i) => ({
    speaker: i % 3 === 0 ? "Narrator" : i % 2 === 0 ? "Hero" : "Friend",
    emotion: document.getElementById("tone").value,
    line: text.trim()
  }));

  document.getElementById("sceneOutput").textContent =
    "ðŸŽ¬ SCENES:\n" + JSON.stringify(scenes, null, 2) +
    "\n\nðŸŽ­ DIALOGUES:\n" + JSON.stringify(dialogues, null, 2);
}

// REAL AI IMAGE GENERATION (STABLE DIFFUSION)
function generateImages() {
  images = scenes.map(scene =>
    "https://image.pollinations.ai/prompt/" + encodeURIComponent(scene.visual)
  );
  alert("AI Scene Images Ready!");
}

// REAL MULTI-CHARACTER AI VOICE ACTING
function playVoice() {
  if (!dialogues.length) return alert("Generate scenes first");

  let synth = window.speechSynthesis;
  let index = 0;

  function speakNext() {
    if (index >= dialogues.length) return;

    let d = dialogues[index];
    let utter = new SpeechSynthesisUtterance(d.line);

    if (d.speaker === "Narrator") utter.pitch = 0.9;
    if (d.speaker === "Hero") utter.pitch = 1.1;
    if (d.speaker === "Friend") utter.pitch = 1.3;

    utter.rate = 0.95;

    utter.onend = () => {
      index++;
      speakNext();
    };

    synth.speak(utter);
  }

  speakNext();
}

// REAL AI VIDEO RENDER (IMAGES + SUBTITLES)
function renderVideo() {
  let canvas = document.getElementById("videoCanvas");
  let ctx = canvas.getContext("2d");

  let i = 0;

  function drawScene() {
    if (i >= dialogues.length) return;

    let img = new Image();
    img.crossOrigin = "anonymous";
    img.src = images[i] || "";

    img.onload = () => {
      ctx.drawImage(img, 0, 0, 360, 640);

      // Overlay fade
      ctx.fillStyle = "rgba(0,0,0,0.35)";
      ctx.fillRect(0, 0, 360, 640);

      // Subtitle box
      ctx.fillStyle = "rgba(0,0,0,0.7)";
      ctx.fillRect(10, 470, 340, 130);

      // Subtitle text
      ctx.fillStyle = "#fff";
      ctx.font = "16px Arial";
      drawWrapped(ctx, dialogues[i].speaker + ": " + dialogues[i].line, 20, 510, 320, 22);

      i++;
      setTimeout(drawScene, 3000);
    };
  }

  drawScene();
}

// TEXT WRAP
function drawWrapped(ctx, text, x, y, maxWidth, lineHeight) {
  let words = text.split(" ");
  let line = "";

  for (let n = 0; n < words.length; n++) {
    let testLine = line + words[n] + " ";
    if (ctx.measureText(testLine).width > maxWidth && n > 0) {
      ctx.fillText(line, x, y);
      line = words[n] + " ";
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}

// EXPORT REAL MP4
function exportVideo() {
  let canvas = document.getElementById("videoCanvas");
  let stream = canvas.captureStream(30);
  let recorder = new MediaRecorder(stream);
  let chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = () => {
    let blob = new Blob(chunks, { type: "video/mp4" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "real_ai_video.mp4";
    a.click();
  };

  recorder.start();
  setTimeout(() => recorder.stop(), dialogues.length * 3200);
}
</script>




